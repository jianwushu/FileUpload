# 测试图片生成器使用说明（多线程优化版）

## 功能概述

测试图片生成器是文件上传系统的一个辅助工具，用于在监控目录中批量生成测试图片，支持**多线程并行生成**，可生成**100万张**测试图片，极大提高测试效率。

## 🆕 v2.0 新功能

- ✅ **多线程并行生成**: 支持1-100个并发线程，大幅提升生成速度
- ✅ **序号连续性保证**: 使用原子操作确保多线程环境下序号连续不重复
- ✅ **进度显示**: 实时显示生成进度百分比
- ✅ **取消功能**: 支持随时停止生成过程
- ✅ **性能优化**: 优化图片渲染算法，提高生成速度
- ✅ **大批量支持**: 支持生成1-1,000,000张图片

## 使用方法

### 1. 打开生成器
- 启动文件上传程序
- 点击菜单 **文件** → **生成测试图片**

### 2. 配置参数
在弹出的测试图片生成器窗口中：

| 参数 | 说明 | 默认值 | 取值范围 |
|------|------|--------|----------|
| **生成数量** | 要生成的图片数量 | 5 | 1-1,000,000 |
| **起始序号** | 起始序号 | 1 | ≥1 |
| **图片宽度** | 图片宽度（像素） | 800 | 100-4000 |
| **图片高度** | 图片高度（像素） | 600 | 100-4000 |
| **并发数** | 同时生成的线程数 | CPU核心数 | 1-100 |

### 3. 开始生成
- 点击 **生成** 按钮开始创建测试图片
- 生成过程中会显示**进度条**和**进度百分比**
- 可以点击 **停止** 按钮取消生成

### 4. 生成完成
- 图片自动保存到监控目录
- 显示成功消息，包含生成数量和并发数

## 并发性能优化建议

### 并发数设置参考

| CPU核心数 | 推荐并发数 | 说明 |
|----------|-----------|------|
| 4核 | 4-8 | 轻度使用场景 |
| 8核 | 8-16 | 中度使用场景 |
| 16核+ | 16-32 | 重度使用场景 |
| 100万张图片 | CPU核心数×2 | 最佳性能 |

### 生成速度参考

| 并发数 | 800×600图片生成速度 | 备注 |
|--------|-------------------|------|
| 1 | ~2张/秒 | 单线程基准 |
| 4 | ~6-8张/秒 | 4倍提升 |
| 8 | ~12-15张/秒 | 8倍提升 |
| 16 | ~20-25张/秒 | 16倍提升 |

*注：实际速度取决于CPU性能、磁盘写入速度等因素*

## 图片命名格式

```
TEST_序号_时间戳_用于图片上传验证.jpg
```

**示例**：
- TEST_0001_20231127143925123_用于图片上传验证.jpg
- TEST_0002_20231127143925156_用于图片上传验证.jpg
- TEST_0003_20231127143925189_用于图片上传验证.jpg

## 序号连续性保证

多线程环境下，使用 **`Interlocked.Increment`** 原子操作确保：
- ✅ 每个序号唯一不重复
- ✅ 序号连续递增（无跳跃）
- ✅ 高并发下序号依然正确

## 图片内容

每张测试图片包含：
- **标题**: "测试图片"
- **序号**: 从起始序号开始的递增序号
- **时间戳**: 精确到毫秒的时间戳（yyyyMMddHHmmssfff）
- **说明文字**: "用于图片上传验证"
- **装饰元素**: 渐变背景、边框、四角圆形装饰
- **生成时间**: 图片创建的时间

## 保存位置

测试图片会直接保存到配置的监控目录中，文件上传服务会自动检测并处理这些文件。

## 注意事项

### 生成前准备
1. **监控目录配置**: 确保已在config.yml中正确配置监控目录
2. **磁盘空间**: 确保有足够空间存储生成的图片
   - 估算：800×600 JPEG图片约50-100KB/张
   - 100万张图片约需 50-100 GB 空间

### 生成过程中
3. **不要关闭程序**: 生成过程中请勿关闭程序或窗体
4. **可随时取消**: 点击"停止"按钮可取消生成
5. **进度查看**: 进度条显示当前完成百分比

### 性能优化建议
6. **并发数不是越大越好**: 超过CPU核心数×2可能因上下文切换导致性能下降
7. **磁盘I/O**: SSD硬盘可显著提升生成速度
8. **内存使用**: 大批量生成时系统可能占用较多内存

## 与现有功能集成

- **自动上传**: 生成的图片会自动被文件上传服务检测并上传
- **文件名解析**: 可以通过配置的文件名解析规则从图片名中提取参数
- **日志记录**: 上传过程会记录在日志中，包括成功/失败状态
- **统计显示**: 上传统计信息会实时显示在主界面
- **线程池上传**: 可结合文件上传服务的线程池功能进行并发上传测试

## 使用场景

### 1. 大批量测试
- 生成1万-100万张图片
- 测试长时间运行的稳定性
- 验证内存使用情况

### 2. 性能压力测试
- 测试并发上传性能
- 验证API接口吞吐量
- 测试磁盘I/O性能

### 3. 功能验证
- 验证文件名解析规则
- 测试参数提取准确性
- 验证错误处理机制

### 4. 系统稳定性测试
- 长时间运行测试
- 资源泄漏检测
- 并发场景测试

## 批量生成示例

### 生成10万张图片（推荐配置）
```
生成数量: 100000
起始序号: 1
图片宽度: 800
图片高度: 600
并发数: 16
```
预计生成时间：约1-2小时

### 生成100万张图片（推荐配置）
```
生成数量: 1000000
起始序号: 1
图片宽度: 800
图片高度: 600
并发数: 32
```
预计生成时间：约10-20小时（取决于硬件性能）

## 故障排除

### 生成速度慢
- 增大并发数（但不超过CPU核心数×2）
- 使用SSD硬盘
- 关闭其他占用CPU的程序

### 序号重复
- 重新生成（原子操作保证不会重复）
- 检查并发数设置

### 内存占用高
- 适当降低并发数
- 重启程序清理内存

### 生成失败
- 检查磁盘空间
- 检查监控目录权限
- 查看错误提示信息

---

**版本**: v2.0
**最后更新**: 2025-11-27
**支持最大数量**: 1,000,000张图片
**最大并发数**: 100线程
